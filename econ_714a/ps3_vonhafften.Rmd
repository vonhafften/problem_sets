---
title: "ECON 714A - Problem Set 3"
author: "Alex von Hafften^[I worked on this problem set with a study group of Michael Nattinger, Andrew Smith, and Ryan Mather. I also discussed problems with Sarah Bass, Emily Case, Danny Edgel, and Katherine Kwok.]"
date: "2/15/2020"
output: pdf_document
header-includes:
- \newcommand{\N}{\mathbb{N}}
- \newcommand{\Z}{\mathbb{Z}}
- \newcommand{\R}{\mathbb{R}}
- \newcommand{\Q}{\mathbb{Q}}
- \newcommand{\Lf}{\mathcal{L}}
- \newcommand{\graph}{\text{graph}}
- \usepackage{bm}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(lubridate)
library(quantmod)
library(mFilter)
library(stargazer)
library(nleqslv)
library(knitr)

loadSymbols(c("PCECC96","GDPC1", "CE16OV", "GPDIC1"), 
      src = "FRED",
      auto.assign = TRUE)
```

This problem asks you to update the CKM (2007) wedge accounting using more recent data.You are encouraged to use Matlab for the computations. Consider a standard RBC model with the CRRA preferences $E_0 \sum_{t=0}^{\infty} \beta^t U(C_t, L_t)$, $U(C, L) = \frac{C^{1-\sigma} - 1}{1 - \sigma} - \frac{L^{1+\phi}}{1+\phi}$, a Cobb-Douglas production function $Y_t=A_tK^\alpha_tL^{1-\alpha}_t$, a standard capital law of motion $K_{t+1}= (1-\delta)K_t+I_t$, and four wedges $\tau_t=\{a_t,g_t, \tau_{Lt},\tau_{It}\}$. Each wedge $\tau_{it}$ follows an AR(1) process $\tau_{it}=\rho_i \tau_{it-1}+ \varepsilon_{it}$ with innovations $\varepsilon_{it}$ potentially correlated across $i$. One period corresponds to a quarter.

1. Download quarterly data for real seasonally adjusted consumption, employment, and output in the U.S. from 1980–2020 from FRED database. The series for capital are not readily available, but can be constructed using the “perpetual inventory method”. To this end, download the series for (real seasonally adjusted) investment from 1950-2020.

```{r problem1b, echo = FALSE, warnings = FALSE}

temp1 <- cbind(PCECC96, GDPC1, CE16OV, GPDIC1) 

temp2 <- temp1 %>%
 as_tibble() %>%
 transmute(date = ymd(index(temp1)),
      consumption = PCECC96,
      output = GDPC1,
      labor = CE16OV,
      investment = GPDIC1) %>%
 filter(!is.na(consumption + output + labor + investment))

data <- temp2 %>% 
mutate(estimation_period = date >= ymd("1980-01-01"),
    consumption = case_when( estimation_period ~ consumption),
    output = case_when( estimation_period ~ output),
    labor = case_when( estimation_period ~ labor)) %>%
 filter(date >= ymd("1950-01-01"),
     date <= ymd("2020-10-01"))

data %>%
 pivot_longer(-c(date, estimation_period)) %>%
  remove_missing(na.rm = TRUE) %>%
 ggplot(aes(x=date, y=value, col = name)) +
 geom_line() +
 facet_wrap(~name, scales = "free_y") +
 theme(legend.position = "none") +
  ggtitle("Raw Data")

```

\pagebreak

2. Convert all variables into logs and de-trend using the Hodrick-Prescott filter.

```{r problem2, echo = FALSE, warnings = FALSE}

data_hp_raw <- data %>%
 filter(estimation_period) %>%
 transmute(date,
      consumption = hpfilter(log(consumption), freq = 1600)$cycle,
      output = hpfilter(log(output), freq = 1600)$cycle,
      labor = hpfilter(log(labor), freq = 1600)$cycle) %>%
 full_join(data %>%
        transmute(date,
             estimation_period,
             investment = hpfilter(log(investment), 
                        freq = 1600)$cycle),
      by = "date") %>%
 arrange(date)

data_hp_raw %>%
 pivot_longer(-c(date, estimation_period)) %>%
    remove_missing(na.rm = TRUE) %>%
 ggplot(aes(x=date, y=value, col = name)) +
 geom_line() +
  ggtitle("Data after HP Filter (in log deviations)")
```

3. Assume that capital was at the steady-state level in 1950 and the rate of depreciation is $\delta= 0.025$ and use the linearized capital law of motion and the series for investment to estimate the capital stock (in log deviations) in 1980-2020. Justify this approach.

Log-linearizing the capital law of motion,

\begin{align*}
K_{t+1} &= (1-\delta)K_t+I_t \\
\implies (1+k_{t+1})\bar{K} &= (1-\delta)(1+k_t)\bar{K} + \bar{I} (1 + i_t) \\
\implies \bar{K}+k_{t+1}\bar{K} &= (1-\delta)\bar{K}+(1-\delta)\bar{K}k_t + \bar{I} + \bar{I} i_t \\
\implies k_{t+1} &= (1-\delta)k_t + \frac{\bar{I}}{\bar{K}} i_t \\
\implies k_{t+1} &= (1-\delta)k_t + \delta i_t
\end{align*}

If we assume that we're in the steady state in 1950, then $k_t = 0$. Thus, we can interate forward using $i_t$ from the data over the next thirty years until 1980.

```{r problem3, echo = FALSE}

delta <- 0.025

capital <- 0

for (i in 2:nrow(data_hp_raw)) capital <- c(capital, (1-delta)*capital[i-1] + delta * data_hp_raw$investment[i-1])

data_hp <- data_hp_raw %>%
 mutate(capital = capital) %>%
 filter(estimation_period) %>%
 select(-estimation_period)

data_hp %>%
  select(date, output, capital) %>%
  pivot_longer(-date) %>%
  ggplot(aes(x=date, y=value, col = name)) +
  geom_line() +
  ggtitle("Estimated Capital Stock (in log deviations)")
 
```

4. Linearize the equilibrium conditions. Assuming $\beta = 0.99$, $\alpha= 1/3$, $\sigma= 1$, $\phi= 1$ and the steady-state share of government spendings in GDP equal 1/3, estimate $a_t$, $g_t$ and $\tau_{Lt}$ for 1980-2020.  Run the OLS regression for each of these wedges to compute their persistence parameters $\rho_i$.

The equilibrium conditions from the lecture notes are:

\begin{align*}
Y_t &= A_tK_t^\alpha L_t^{1-\alpha} \\
A_t F(K_t, L_t) &= C_t + I_t + G_t \\
-\frac{U_{L_t}}{U_{C_t}} &= (1-\tau_{L_t})A_t F_{L_t} \\
U_{C_t} (1 + \tau_{I_t}) &= \beta E_t U_{C_{t+1}} (A_{t+1} F_{K_{t+1}} + (1-\delta)(1+\tau_{I_{t+1}}))
\end{align*}

The functional forms from the prompt:

\begin{align*}
U(C_t, L_t) &= \ln(C_t) - \frac{L_t^2}{2} \\
\implies U_{C_t} &= \frac{1}{C_t} \\
\implies U_{L_t} &= - L_t \\
F(K_t, L_t) &= K_t^\alpha L_t^{1-\alpha} \\
\implies F_{L_t} &= (1 -\alpha)K_t^\alpha L_t^{-\alpha} \\
\implies F_{K_t} &= \alpha K_t^{\alpha-1} L_t^{1-\alpha} 
\end{align*}

Thus, the equilibrium conditions become:

\begin{align*}
A_tK_t^\alpha L_t^{1-\alpha} &= C_t + I_t + G_t \\
C_tL_t &= (1-\tau_{L_t})A_t (1 -\alpha)K_t^\alpha L_t^{-\alpha} \\
\frac{1}{C_t} (1 + \tau_{I_t}) &= \beta E_t \frac{1}{C_{t+1}} (A_{t+1} \alpha K_t^{\alpha-1} L_t^{1-\alpha} + (1-\delta)(1+\tau_{I_{t+1}}))
\end{align*}

In the steady state, $K_t = K_{t+1} = \bar{K}$, $C_t = C_{t+1} = \bar{C}$, $L_t = L_{t+1} = \bar{L}$, $I_t = I_{t+1} = \delta \bar{K}$, $G_t = G_{t+1} = \bar{G} = \bar{Y}/3$, and $A_t = A_{t+1} = \bar{A} = 1$.

\begin{align*}
(2/3)\bar{K}^\alpha \bar{L}^{1-\alpha} &= \bar{C} + \delta \bar{K} \\
\bar{C}  &= (1-\bar{\tau_L}) (1 -\alpha)\bar{K}^\alpha\bar{L}^{-1-\alpha} \\
1 + \bar{\tau_I} &= \beta  ( \alpha \bar{K}^{\alpha-1} \bar{L}^{1-\alpha} + (1-\delta)(1+\bar{\tau_I}))
\end{align*}

We can solve for the labor steady state:

\begin{align*}
(2/3)\bar{K}^\alpha \bar{L}^{1-\alpha} - \delta \bar{K} 
&= (1-\bar{\tau_L}) (1 -\alpha)\bar{K}^\alpha \bar{L}^{-1-\alpha} \\
\implies 
\delta &= (2/3)\bar{K}^{\alpha-1} \bar{L}^{1-\alpha} - (1-\bar{\tau_L}) (1 -\alpha)\bar{K}^{\alpha-1} \bar{L}^{-1-\alpha} \\
\implies 
\bar{K} 
&= (\frac{\delta}{(2/3)\bar{L}^{1-\alpha} - (1-\bar{\tau_L})(1-\alpha)\bar{L}^{-1-\alpha}})^{1/(\alpha-1)} \\
\implies
1 + \bar{\tau_I} 
&= \beta  ( \alpha \frac{\delta}{(2/3)L^{1-\alpha} - (1-\bar{\tau_L})(1-\alpha)\bar{L}^{-1-\alpha}} \bar{L}^{1-\alpha} + (1-\delta)(1+\bar{\tau_I}))\\
\implies 
(1/\beta - 1 + \delta)(1+\bar{\tau_I})
&= \frac{\alpha\delta}{(2/3) - (1-\bar{\tau_L})(1-\alpha)\bar{L}^{-2}} \\
\implies
\bar{L}
&= \sqrt{\frac{(1-\bar{\tau_L})(1-\alpha)}{(2/3) - \frac{\alpha\delta}{ (1/\beta - 1 + \delta)(1+\bar{\tau_I})}}} \\
\end{align*}

The steady state values of $\bar{Y}, \bar{K}, \bar{C}$, and $\bar{G}$ are implied by the equations above.  For $\bar{\tau}_L = \bar{\tau}_I = 0.5$, the steady state values are:

```{r problem4a, echo = FALSE}
alpha <- 1/3
sigma <- 1
phi <- 1
tau_l_ss <- .5
tau_i_ss <- .5
alpha <- 1/3
beta <- .99
sigma <- 1
phi <- 1
  
labor_ss <- sqrt(((1-tau_l_ss)*(1-alpha))/((2/3) - (alpha*delta)/((1/beta - 1 + delta)*(1+tau_i_ss))))
capital_ss <- (delta / ((2/3)*labor_ss^(1-alpha) - (1- tau_l_ss)*(1 - alpha) * labor_ss^(-1-alpha)))^(1/(alpha - 1))
investment_ss <- capital_ss *delta
output_ss <- capital_ss ^ alpha *labor_ss ^(1-alpha)
government_ss <- (1/3)*output_ss
consumption_ss <- output_ss - investment_ss - government_ss

tibble(variable = c("L_bar", "K_bar", "I_bar", "Y_bar", "C_bar",  "G_bar"),
       value = c(labor_ss, capital_ss, investment_ss, output_ss, consumption_ss, government_ss)) %>%
  mutate(value = round(value, 3)) %>%
  kable()

```

\pagebreak

Now we can turn to the wedges.  The efficiency wedge is:

\begin{align*}
Y_t &= A_tK_t^\alpha L_t^{1-\alpha} \\
\implies 
y_t &= a_t + \alpha k_t + (1-\alpha)l_t \\
\implies 
a_t &= y_t - \alpha k_t - (1-\alpha)l_t
\end{align*}

The government consumption wedge is:

\begin{align*}
Y_t &= C_t + I_t + G_t \\
\implies
\bar{Y}(1+y_t) &= \bar{C}(1+c_t) + \bar{I}(1+i_t) + \bar{G}(1+g_t) \\
\implies
\bar{Y}y_t &= \bar{C}c_t + \bar{I}i_t + \bar{G}g_t \\
\implies
g_t 
&= \frac{\bar{Y}y_t - \bar{C}c_t - \bar{I}i_t}{\bar{G}} \\
&= \frac{\bar{Y}}{\bar{G}}y_t - \frac{\bar{C}}{\bar{G}}c_t - \frac{\bar{I}}{\bar{G}}i_t
\end{align*}

The labor wedge is: 

\begin{align*}
C_tL_t^{1+\alpha} 
&= (1-\tau_{L_t})A_t (1 -\alpha)K_t^\alpha \\
\implies 
c_t+ (1+\alpha) l_t 
&= \hat{\tau_{L_t}}\frac{- \bar{\tau}_L}{1 - \bar{\tau}_L}+ a_t  + \alpha k_t \\
\implies 
\hat{\tau_{L_t}} 
&= \frac{1 - \bar{\tau}_L}{ \bar{\tau}_L} a_t  + \alpha \frac{1 - \bar{\tau}_L}{ \bar{\tau}_L} k_t - \frac{1 - \bar{\tau}_L}{ \bar{\tau}_L} c_t -  (1+\alpha) \frac{1 - \bar{\tau}_L}{ \bar{\tau}_L} l_t
\end{align*}

```{r problem4, echo=FALSE, results = "asis"}
data_wedge <- data_hp %>%
  transmute(date, 
            efficiency = output - alpha * capital - (1 - alpha) * labor,
            government = (output_ss * output - consumption_ss * consumption - investment_ss * investment) / government_ss,
            labor = ((1 - tau_l_ss) / tau_l_ss) * (efficiency + alpha * capital - consumption - (1 + alpha) * labor))

data_wedge %>%
 pivot_longer(-date) %>%
 ggplot(aes(x=date, y=value, col = name)) +
 geom_line() +
  ggtitle("Efficiency, Government, and Labor Wedges")

efficiency_wedge_ols <- lm(efficiency ~ lag(efficiency) - 1, data = data_wedge)
government_wedge_ols <- lm(government ~ lag(government)- 1, data = data_wedge)
labor_wedge_ols <- lm(labor ~ lag(labor)- 1, data = data_wedge)

stargazer(efficiency_wedge_ols,
          government_wedge_ols,
          labor_wedge_ols,
          header = FALSE,
          omit.stat = c("rsq", "f", "ser"),
          title = "Efficiency, Government, and Labor Wedge Persistance (OLS)")
```

\pagebreak

5. Write down a code that implements the Blanchard-Kahn method to solve the model. Use the values of parameters, including $\rho_a$, $\rho_g$, and $\rho_{\tau_L}$, obtained above, and assume $\rho_{\tau_I} = 0$ for now.

...

```{r problem5, echo = FALSE}

# rho_a <- as.numeric(efficiency_wedge_ols$coef[1])
# rho_g <- as.numeric(government_wedge_ols$coef[1])
# rho_tau_l <- as.numeric(labor_wedge_ols$coef[1])
# rho_tau_i <- 0

```

\pagebreak

# Appendix

```{r problem1a}
# PCECC96 Real Personal Consumption Expenditures  Billions of Chained 2012 Dollars, 
#                                                 Seasonally Adjusted Annual Rate
# GDPC1   Real Gross Domestic Product             Billions of Chained 2012 Dollars
#                                                 Seasonally Adjusted Annual Rate
# CE16OV  Employment Level                        Thousands of Persons
#                                                 Seasonally Adjusted
# GPDIC1  Real Gross Private Domestic Investment  Billions of Chained 2012 Dollars
#                                                 Seasonally Adjusted Annual Rate
```


```{r problem4_sym, echo = FALSE, eval =FALSE}
tau_l_bar <- .1
tau_i_bar <- .1
alpha <- 1/3
beta <- .99
sigma <- 1
phi <- 1

# x[1] is kbar
# x[2] is lbar
# x[3] is cbar
solve_ss <- function(x) {
  y <- numeric(3)
  
  y[1] <- (2/3)*x[1]^alpha *x[2]^(1-alpha) - x[3] - delta * x[1]
  y[2] <- x[3] *x[2]^(1+alpha) - (1-tau_l_bar) *(1 -alpha) * x[1]^alpha
  y[3] <- 1 + tau_i_bar - beta  * ( alpha *x[1]^(alpha-1) * x[2]^(1-alpha) + (1-delta) * (1+tau_i_bar))
  
  return(y)
}

nleqslv(c(29.26, 1.15, 1.53), solve_ss)

```